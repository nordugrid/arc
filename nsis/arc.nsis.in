Name "NorduGrid ARC"
OutFile "nordugrid-arc-nox-@VERSION@-1.exe"
InstallDir "$PROGRAMFILES\NorduGridArc"
InstallDirRegKey HKLM SOFTWARE\NorduGridArc "Install_Dir"
ShowInstDetails hide
ShowUninstDetails hide
XPStyle on

!include EnvVarUpdate.nsh

; include for some of the windows messages defines
!include "winmessages.nsh"

; HKLM (all users) vs HKCU (current user) defines
!define env_hklm 'HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment"'
!define env_hkcu 'HKCU "Environment"'

!define SYS_PATH "/usr/i686-pc-mingw32/sys-root/mingw"
!define ARC_LOCATION "/usr/i686-pc-mingw32/sys-root/mingw"
!define GLOBUS_LOCATION "/usr/i686-pc-mingw32/sys-root/mingw"
!define CERT_PATH "/etc/grid-security/certificates"
!define MISC_PATH "."

PageEx license
  LicenseData ${MISC_PATH}/license.txt
  LicenseForceSelection checkbox
PageExEnd

Page components
Page directory
Page instfiles

UninstPage uninstConfirm
UninstPage instfiles

ComponentText "Select which optional components you want to install."

DirText "Please select the installation folder."
Section "NorduGrid ARC clients"
  SectionIn RO

  SetOutPath "$INSTDIR"
  File "${MISC_PATH}/README.txt"

  SetOutPath "$INSTDIR\share\arc\examples"
  File "${ARC_LOCATION}/share/arc/examples/client.conf.example"

  SetOutPath "$INSTDIR\bin"
  File "${ARC_LOCATION}/bin/arccat.exe"
  File "${ARC_LOCATION}/bin/arcclean.exe"
  File "${ARC_LOCATION}/bin/arccp.exe"
  File "${ARC_LOCATION}/bin/arcdecision.exe"
  File "${ARC_LOCATION}/bin/arcecho.exe"
  File "${ARC_LOCATION}/bin/arcget.exe"
  File "${ARC_LOCATION}/bin/arcinfo.exe"
  File "${ARC_LOCATION}/bin/arckill.exe"
  File "${ARC_LOCATION}/bin/arcls.exe"
  File "${ARC_LOCATION}/bin/arcmigrate.exe"
  File "${ARC_LOCATION}/bin/arcproxy.exe"
  File "${ARC_LOCATION}/bin/arcrenew.exe"
  File "${ARC_LOCATION}/bin/arcresub.exe"
  File "${ARC_LOCATION}/bin/arcresume.exe"
  File "${ARC_LOCATION}/bin/arcrm.exe"
  File "${ARC_LOCATION}/bin/arcsrmping.exe"
  File "${ARC_LOCATION}/bin/arcslcs.exe"
  File "${ARC_LOCATION}/bin/arcstat.exe"
  File "${ARC_LOCATION}/bin/arcsub.exe"
  File "${ARC_LOCATION}/bin/arcsync.exe"
  File "${ARC_LOCATION}/bin/arcwsrf.exe"
  File "${ARC_LOCATION}/bin/libarcclient-0.dll"
  File "${ARC_LOCATION}/bin/libarccommon-0.dll"
  File "${ARC_LOCATION}/bin/libarccredential-0.dll"
  File "${ARC_LOCATION}/bin/libarccrypto-0.dll"
  File "${ARC_LOCATION}/bin/libarcdata2-0.dll"
  File "${ARC_LOCATION}/bin/libarcloader-0.dll"
  File "${ARC_LOCATION}/bin/libarcmessage-0.dll"
  File "${ARC_LOCATION}/bin/libarcsecurity-0.dll"
  File "${ARC_LOCATION}/bin/libarcws-0.dll"
  File "${ARC_LOCATION}/bin/libarcwssecurity-0.dll"
  File "${ARC_LOCATION}/bin/libarcxmlsec-0.dll"
  File "${ARC_LOCATION}/bin/perftest.exe"
  File "${ARC_LOCATION}/bin/saml_assertion_init.exe"

  File "${SYS_PATH}/bin/libcrypto-8.dll"
  File "${SYS_PATH}/bin/libgcc_s_sjlj-1.dll"
  File "${SYS_PATH}/bin/libglib-2.0-0.dll"
  File "${SYS_PATH}/bin/libglibmm-2.4-1.dll"
  File "${SYS_PATH}/bin/libgmodule-2.0-0.dll"
  File "${SYS_PATH}/bin/libgnurx-0.dll"
  File "${SYS_PATH}/bin/libgobject-2.0-0.dll"
  File "${SYS_PATH}/bin/libgthread-2.0-0.dll"
  File "${SYS_PATH}/bin/libiconv-2.dll"
  File "${SYS_PATH}/bin/libintl-8.dll"
  File "${SYS_PATH}/bin/libgio-2.0-0.dll"
  File "${SYS_PATH}/bin/libgiomm-2.4-1.dll"
  File "${SYS_PATH}/bin/libsigc-2.0-0.dll"
  File "${SYS_PATH}/bin/libssl-8.dll"
  File "${SYS_PATH}/bin/libxml2-2.dll"
  File "${SYS_PATH}/bin/libxmlsec1.dll"
  File "${SYS_PATH}/bin/libxmlsec1-openssl.dll"
  File "${SYS_PATH}/bin/libxslt-1.dll"
  File "${SYS_PATH}/bin/zlib1.dll"

; Globus ARC dependencies
  SetOutPath "$INSTDIR\bin"
  File "${GLOBUS_LOCATION}/bin/libglobus_common-0.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_gsi_callback-0.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_gsi_cert_utils-0.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_gsi_credential-1.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_gsi_proxy_core-0.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_gsi_sysconfig-1.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_gssapi_error-2.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_gssapi_gsi-4.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_gss_assist-3.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_io-3.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_openssl-0.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_openssl_error-0.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_proxy_ssl-1.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_xio-0.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_ftp_control-1.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_gsi_callback-0.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_gsi_credential-1.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_gsi_proxy_core-0.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_gssapi_gsi-4.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_oldgaa-0.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_callout-0.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_ftp_client-1.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_ftp_control-1.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_gssapi_error-2.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_gss_assist-3.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_io-3.dll"
  File "${GLOBUS_LOCATION}/bin/libglobus_rls_client-5.dll"

; Globus plugins
  SetOutPath "$INSTDIR\lib"
  File "${GLOBUS_LOCATION}/lib/libglobus_xio_gsi_driver-0.dll"
  File "${GLOBUS_LOCATION}/lib/libglobus_xio_popen_driver-0.dll"

  SetOutPath "$INSTDIR\lib\arc"
  File "${ARC_LOCATION}/lib/arc/libaccARC1.dll"
  File "${ARC_LOCATION}/lib/arc/libaccBroker.dll"
  File "${ARC_LOCATION}/lib/arc/libaccCREAM.dll"
  File "${ARC_LOCATION}/lib/arc/libaccUNICORE.dll"
  File "${ARC_LOCATION}/lib/arc/libarcshc.dll"
  File "${ARC_LOCATION}/lib/arc/libdmcarc.dll"
  File "${ARC_LOCATION}/lib/arc/libdmcfile.dll"
  File "${ARC_LOCATION}/lib/arc/libdmchttp.dll"
  File "${ARC_LOCATION}/lib/arc/libidentitymap.dll"
  File "${ARC_LOCATION}/lib/arc/libmcchttp.dll"
;  File "${ARC_LOCATION}/lib/arc/libmccmsgvalidator.dll"
  File "${ARC_LOCATION}/lib/arc/libmccsoap.dll"
  File "${ARC_LOCATION}/lib/arc/libmcctcp.dll"
  File "${ARC_LOCATION}/lib/arc/libmcctls.dll"
  File "${ARC_LOCATION}/lib/arc/libmodcrypto.dll"
  File "${ARC_LOCATION}/lib/arc/libmodcredential.dll"

; Extra stuff now we have Globus
  File "${ARC_LOCATION}/lib/arc/libaccARC0.dll"
  File "${ARC_LOCATION}/lib/arc/libdmcgridftp.dll"
  File "${ARC_LOCATION}/lib/arc/libdmcldap.dll"
  File "${ARC_LOCATION}/lib/arc/libdmcrls.dll"
  File "${ARC_LOCATION}/lib/arc/libmccgsi.dll"

;; Fix for bug #1563 
;  SetOutPath "$INSTDIR\lib"
;  File /oname=libarccrypto.dll "${ARC_LOCATION}/bin/libarccrypto-0.dll"

  SetOutPath "$INSTDIR\etc\arc"
  File "${ARC_LOCATION}/etc/arc/client.conf"

  SetOutPath "$INSTDIR\etc\grid-security"
  File "${MISC_PATH}/vomses"
SectionEnd

;Section "NorduGrid ARC Server"
;
;  SetOutPath "$INSTDIR\sbin"
;  File "${ARC_LOCATION}/sbin/arched.exe"
;
;  SetOutPath "$INSTDIR\lib\arc"
;  File "${ARC_LOCATION}/lib/arc/libslcs.dll"
;  File "${ARC_LOCATION}/lib/arc/libecho.dll"
;  File "${ARC_LOCATION}/lib/arc/libdelegation.dll"
;  File "${ARC_LOCATION}/lib/arc/libsaml2sp.dll"
;
;SectionEnd

Section "IGTF Certificates"
  SetOutPath "$INSTDIR\etc\grid-security\certificates"
  File "${CERT_PATH}/*.signing_policy"
  File "${CERT_PATH}/*.info"
  File "${CERT_PATH}/*.namespaces"
  File "${CERT_PATH}/*.crl_url"
  File "${CERT_PATH}/*.0"
SectionEnd


Section "Uninstall"

  Delete /rebootok "$INSTDIR\UninstallNorduGridARC.exe"

  Delete /rebootok "$INSTDIR\lib\arc\libmodcrypto.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libmodcredential.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libmcctls.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libmcctcp.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libmccsoap.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libmccmsgvalidator.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libmcchttp.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libidentitymap.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libdmchttp.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libdmcfile.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libdmcarc.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libarcshc.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libaccUNICORE.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libaccCREAM.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libaccBroker.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libaccARC1.dll"

  Delete /rebootok "$INSTDIR\lib\arc\libaccARC0.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libdmcldap.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libdmcgridftp.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libmccgsi.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libdmcrls.dll"

  Delete /rebootok "$INSTDIR\lib\arc\libsaml2sp.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libdelegation.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libslcs.dll"
  Delete /rebootok "$INSTDIR\lib\arc\libecho.dll"

  RMDir "$INSTDIR\lib\arc"

  Delete /rebootok "$INSTDIR\lib\libarccrypto.dll"

  RMDir "$INSTDIR\lib"

  Delete /rebootok "$INSTDIR\bin\zlib1.dll"
  Delete /rebootok "$INSTDIR\bin\libxslt-1.dll"
  Delete /rebootok "$INSTDIR\bin\libxmlsec1-openssl.dll"
  Delete /rebootok "$INSTDIR\bin\libxmlsec1.dll"
  Delete /rebootok "$INSTDIR\bin\libxml2-2.dll"
  Delete /rebootok "$INSTDIR\bin\libssl-8.dll"
  Delete /rebootok "$INSTDIR\bin\libgiomm-2.4-1.dll"
  Delete /rebootok "$INSTDIR\bin\libgio-2.0-0.dll"
  Delete /rebootok "$INSTDIR\bin\libsigc-2.0-0.dll"
  Delete /rebootok "$INSTDIR\bin\libintl-8.dll"
  Delete /rebootok "$INSTDIR\bin\libiconv-2.dll"
  Delete /rebootok "$INSTDIR\bin\libgthread-2.0-0.dll"
  Delete /rebootok "$INSTDIR\bin\libgobject-2.0-0.dll"
  Delete /rebootok "$INSTDIR\bin\libgnurx-0.dll"
  Delete /rebootok "$INSTDIR\bin\libgmodule-2.0-0.dll"
  Delete /rebootok "$INSTDIR\bin\libglibmm-2.4-1.dll"
  Delete /rebootok "$INSTDIR\bin\libglib-2.0-0.dll"
  Delete /rebootok "$INSTDIR\bin\libgcc_s_sjlj-1.dll"
  Delete /rebootok "$INSTDIR\bin\libcrypto-8.dll"

  Delete /rebootok "$INSTDIR\bin\saml_assertion_init.exe"
  Delete /rebootok "$INSTDIR\bin\perftest.exe"
  Delete /rebootok "$INSTDIR\bin\libarcxmlsec-0.dll"
  Delete /rebootok "$INSTDIR\bin\libarcwssecurity-0.dll"
  Delete /rebootok "$INSTDIR\bin\libarcws-0.dll"
  Delete /rebootok "$INSTDIR\bin\libarcsecurity-0.dll"
  Delete /rebootok "$INSTDIR\bin\libarcmessage-0.dll"
  Delete /rebootok "$INSTDIR\bin\libarcloader-0.dll"
  Delete /rebootok "$INSTDIR\bin\libarcdata2-0.dll"
  Delete /rebootok "$INSTDIR\bin\libarccredential-0.dll"
  Delete /rebootok "$INSTDIR\bin\libarccommon-0.dll"
  Delete /rebootok "$INSTDIR\bin\libarcclient-0.dll"
  Delete /rebootok "$INSTDIR\bin\libarccrypto-0.dll"
  Delete /rebootok "$INSTDIR\bin\arcwsrf.exe"
  Delete /rebootok "$INSTDIR\bin\arcsync.exe"
  Delete /rebootok "$INSTDIR\bin\arcsub.exe"
  Delete /rebootok "$INSTDIR\bin\arcstat.exe"
  Delete /rebootok "$INSTDIR\bin\arcslcs.exe"
  Delete /rebootok "$INSTDIR\bin\arcsrmping.exe"
  Delete /rebootok "$INSTDIR\bin\arcrm.exe"
  Delete /rebootok "$INSTDIR\bin\arcresume.exe"
  Delete /rebootok "$INSTDIR\bin\arcresub.exe"
  Delete /rebootok "$INSTDIR\bin\arcrenew.exe"
  Delete /rebootok "$INSTDIR\bin\arcproxy.exe"
  Delete /rebootok "$INSTDIR\bin\arcmigrate.exe"
  Delete /rebootok "$INSTDIR\bin\arcls.exe"
  Delete /rebootok "$INSTDIR\bin\arckill.exe"
  Delete /rebootok "$INSTDIR\bin\arcinfo.exe"
  Delete /rebootok "$INSTDIR\bin\arcget.exe"
  Delete /rebootok "$INSTDIR\bin\arcecho.exe"
  Delete /rebootok "$INSTDIR\bin\arcdecision.exe"
  Delete /rebootok "$INSTDIR\bin\arccp.exe"
  Delete /rebootok "$INSTDIR\bin\arcclean.exe"
  Delete /rebootok "$INSTDIR\bin\arccat.exe"

  Delete /rebootok "$INSTDIR\bin\libglobus_common-0.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_ftp_control-1.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_gsi_callback-0.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_gsi_cert_utils-0.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_gsi_credential-1.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_gsi_proxy_core-0.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_gsi_sysconfig-1.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_gssapi_error-2.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_gssapi_gsi-4.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_gss_assist-3.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_io-3.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_oldgaa-0.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_openssl-0.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_openssl_error-0.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_proxy_ssl-1.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_xio-0.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_callout-0.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_ftp_client-1.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_ftp_control-1.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_gssapi_error-2.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_gss_assist-3.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_io-3.dll"
  Delete /rebootok "$INSTDIR\bin\libglobus_rls_client-5.dll"

  RMDir "$INSTDIR\bin"

  Delete /rebootok "$INSTDIR\lib\libglobus_xio_gsi_driver-0.dll"
  Delete /rebootok "$INSTDIR\lib\libglobus_xio_popen_driver-0.dll"

  RMDir "$INSTDIR\lib"

  Delete /rebootok "$INSTDIR\share\arc\examples\client.conf.example"
  RMDir "$INSTDIR\share\arc\examples"
  RMDir "$INSTDIR\share\arc"
  RMDir "$INSTDIR\share"

  Delete /rebootok "$INSTDIR\sbin\arched.exe"

  RMDir "$INSTDIR\sbin"

  Delete /rebootok "$INSTDIR\etc\grid-security\certificates\*"
  Delete /rebootok "$INSTDIR\etc\grid-security\vomses"
  RMDir "$INSTDIR\etc\grid-security\certificates"
  RMDir "$INSTDIR\etc\grid-security"

  Delete /rebootok "$INSTDIR\etc\arc\client.conf"

  RMDir "$INSTDIR\etc\arc"

  RMDir "$INSTDIR\etc"

  Delete /rebootok "$INSTDIR\README.txt"
  RMDir "$INSTDIR"

  ${un.EnvVarUpdate} $0 "PATH" "R" "HKLM" "$INSTDIR\bin"    
  ${un.EnvVarUpdate} $0 "PATH" "R" "HKLM" "$INSTDIR\lib"    
  ${un.EnvVarUpdate} $0 "PATH" "R" "HKLM" "$INSTDIR\lib\arc"  
  ${un.EnvVarUpdate} $0 "PATH" "R" "HKLM" "$INSTDIR\sbin"

  DeleteRegValue ${env_hklm} ARC_LOCATION
  DeleteRegValue ${env_hklm} GLOBUS_LOCATION
  DeleteRegValue ${env_hklm} X509_CERT_DIR
;  DeleteRegValue ${env_hklm} X509_USER_CERT
;  DeleteRegValue ${env_hklm} X509_USER_KEY
;  DeleteRegValue ${env_hklm} X509_USER_PROXY

  SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 "STR:Environment" /TIMEOUT=5000

SectionEnd

Section -post
  WriteUninstaller "$INSTDIR\UninstallNorduGridARC.exe"

  WriteRegExpandStr ${env_hklm} ARC_LOCATION $INSTDIR
  WriteRegExpandStr ${env_hklm} GLOBUS_LOCATION $INSTDIR
  WriteRegExpandStr ${env_hklm} X509_CERT_DIR $INSTDIR\etc\grid-security\certificates
;  WriteRegExpandStr ${env_hklm} X509_USER_CERT  "$PROFILE\.globus\usercert.pem"
;  WriteRegExpandStr ${env_hklm} X509_USER_KEY   "$PROFILE\.globus\userkey.pem"
;  WriteRegExpandStr ${env_hklm} X509_USER_PROXY "$TEMP\x509up_u0"

  SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 "STR:Environment" /TIMEOUT=5000

  ${EnvVarUpdate} $0 "PATH" "A" "HKLM" "$INSTDIR\bin"  ; Append the new one
  ${EnvVarUpdate} $0 "PATH" "A" "HKLM" "$INSTDIR\lib"  ; Append the new one
  ${EnvVarUpdate} $0 "PATH" "A" "HKLM" "$INSTDIR\lib\arc"  ; Append the new one
  ${EnvVarUpdate} $0 "PATH" "A" "HKLM" "$INSTDIR\sbin"  ; Append the new one
SectionEnd

Function .onInstSuccess
  MessageBox MB_YESNO "NorduGrid ARC successfully installed. View README file?" IDNO NoReadme
    Exec "notepad.exe $INSTDIR/README.txt"
  NoReadme:
FunctionEnd
